<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD.Website.Demo - Iowa Map</title>
    <script>if(localStorage.getItem('theme')==='dark')document.documentElement.classList.add('dark-mode');</script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="styles.css" />
    <script src="translations.js"></script>
    <style>
        #map {
            width: 100%;
            height: calc(100vh - 80px - 16px);
            max-width: calc(100vw - 220px - 240px - 20px);
            max-height: calc(100vh - 80px - 16px);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .leaflet-top.leaflet-left {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
        }

        .legend {
            background: white;
            padding: 10px 14px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
            font-size: 13px;
            line-height: 1.4;
            max-height: 380px;
            overflow-y: auto;
        }

        .legend-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .legend h4 {
            margin: 0;
            font-size: 14px;
        }

        .legend-btn-group {
            display: flex;
            gap: 4px;
        }

        .legend-clear-btn {
            font-size: 11px;
            padding: 2px 7px;
            background: #e0e0e0;
            border: 1px solid #bbb;
            border-radius: 3px;
            cursor: pointer;
            color: #444;
            line-height: 1.4;
        }

        .legend-clear-btn:hover {
            background: #c8c8c8;
        }

        html.dark-mode .legend-clear-btn {
            background: #444;
            border-color: #666;
            color: #ddd;
        }

        html.dark-mode .legend-clear-btn:hover {
            background: #555;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 5px;
            cursor: pointer;
        }

        .legend-item input[type="checkbox"] {
            margin: 0;
            flex-shrink: 0;
        }

        .legend-item svg {
            flex-shrink: 0;
        }

        .legend-group {
            font-size: 11px;
            font-weight: bold;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px solid #ddd;
        }

        .legend-group.first {
            border-top: none;
            margin-top: 0;
            padding-top: 0;
        }

        html.dark-mode .legend {
            background: #2c2c3e;
            color: #e0e0e0;
        }

        html.dark-mode .legend-group {
            color: #aaa;
            border-top-color: #555;
        }

        .page-layout.sidebar-hidden #map {
            max-width: calc(100vw - 34px - 240px - 20px);
        }

        #map-error {
            display: none;
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: #fdf0ef;
            border: 1px solid #e9b8b5;
            color: #c0392b;
            padding: 10px 16px;
            border-radius: 5px;
            font-size: 13px;
            max-width: 420px;
            text-align: center;
            pointer-events: none;
        }

        .calculator-panel {
            width: 240px;
            flex-shrink: 0;
            background: #d0d4db;
            border-left: 1px solid #b0b5bc;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            overflow: hidden;
            transition: width 0.25s ease;
        }

        .calc-panel-body {
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex: 1;
        }

        .advanced-calc-btn {
            margin-top: auto;
        }

        .calculator-panel.collapsed {
            width: 34px;
            padding: 0;
        }

        .calculator-panel h3 {
            font-size: 16px;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding: 10px 14px 10px 14px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            transition: background-color 0.25s ease, padding 0.25s ease;
        }

        .calculator-panel.collapsed h3 {
            background-color: #c5ddf7;
            border-bottom: none;
            padding: 0;
            justify-content: flex-start;
            align-items: stretch;
            min-height: 48px;
        }

        .calculator-panel.collapsed h3 span {
            display: none;
        }

        .calc-panel-toggle {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #888;
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
        }

        .calculator-panel.collapsed .calc-panel-toggle {
            color: white;
            width: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calc-panel-toggle:hover { color: #444; }
        .calculator-panel.collapsed .calc-panel-toggle:hover { color: white; background: rgba(0, 0, 0, 0.2); }

        .calc-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .calc-field label {
            font-size: 12px;
            color: #555;
            font-weight: bold;
        }

        .calc-field input {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            width: 100%;
        }

        .calc-btn {
            padding: 8px;
            background: #4169e1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 4px;
        }

        .calc-btn:hover {
            background: #2a52cc;
        }

        .advanced-calc-btn {
            background: #2c3e50;
            text-align: center;
            text-decoration: none;
            display: block;
        }

        .advanced-calc-btn:hover {
            background: #1a252f;
        }

        html.dark-mode .calculator-panel {
            background: #2c2c3e;
            border-left-color: #444;
            color: #e0e0e0;
        }

        html.dark-mode .calculator-panel h3 {
            color: #e0e0e0;
            border-bottom-color: #444;
        }

        html.dark-mode .calc-field label {
            color: #bbb;
        }

        html.dark-mode .calc-field input {
            background: #1a1a2e;
            border-color: #555;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <h1 class="page-heading">
        <div class="logo">
            <svg width="36" height="36" viewBox="0 0 36 36">
                <path d="M18 2 C28 2 34 10 34 18 C34 26 26 34 18 34 C14 28 8 20 2 18 C8 8 14 2 18 2Z" fill="#2ec4b6" stroke="white" stroke-width="1"/>
                <path d="M18 8 C18 8 18 28 18 28" stroke="white" stroke-width="1.5" fill="none"/>
                <path d="M18 14 C14 12 10 14 10 14" stroke="white" stroke-width="1" fill="none"/>
                <path d="M18 20 C22 18 26 20 26 20" stroke="white" stroke-width="1" fill="none"/>
            </svg>
            <span>Logo</span>
        </div>
        <span data-i18n="site-title">Anerobic Digestion Pathways</span>
    </h1>
    <div class="page-layout">
        <nav class="sidebar">
            <ul>
                <li class="home-nav-item"><a href="index.html" class="active" data-i18n="nav-home">Home</a><button class="sidebar-toggle" id="sidebar-toggle-btn" onclick="toggleSidebar()" title="Hide sidebar">&#8592;</button></li>
                <li>
                    <a href="#" onclick="document.getElementById('about-submenu').classList.toggle('open'); return false;" data-i18n="nav-about">About</a>
                    <ul id="about-submenu" class="submenu">
                        <li><a href="about-funding.html" data-i18n="nav-funding">Funding Information</a></li>
                        <li><a href="about-website.html" data-i18n="nav-how">How does this website work?</a></li>
                        <li><a href="about-digestion.html" data-i18n="nav-what">What is anaerobic digestion?</a></li>
                    </ul>
                </li>
                <li><a href="farms.html" data-i18n="nav-farms">Farms</a></li>
                <li><a href="settings.html" data-i18n="nav-settings">Settings</a></li>
                <li><a href="sources.html" data-i18n="nav-sources">Sources</a></li>
            </ul>
        </nav>
        <div class="main-content">
            <div id="map" style="position:relative;">
                <div id="map-error">Map data requires an HTTP server. Open via <strong>http://localhost:5500/index.html</strong> — not as a local file.</div>
            </div>
        </div>
        <div class="calculator-panel" id="calculator-panel">
            <h3><button class="calc-panel-toggle" id="calc-panel-toggle" onclick="toggleCalcPanel()" title="Hide calculator">&#9654;</button><span>Calculator</span></h3>
            <div class="calc-panel-body">
                <div class="calc-field">
                    <label for="calc-1">Prompt 1</label>
                    <input type="number" id="calc-1" placeholder="Enter value">
                </div>
                <div class="calc-field">
                    <label for="calc-2">Prompt 2</label>
                    <input type="number" id="calc-2" placeholder="Enter value">
                </div>
                <div class="calc-field">
                    <label for="calc-3">Prompt 3</label>
                    <input type="number" id="calc-3" placeholder="Enter value">
                </div>
                <div class="calc-field">
                    <label for="calc-4">Prompt 4</label>
                    <input type="number" id="calc-4" placeholder="Enter value">
                </div>
                <div class="calc-field">
                    <label for="calc-5">Prompt 5</label>
                    <input type="number" id="calc-5" placeholder="Enter value">
                </div>
                <button class="calc-btn" data-i18n="btn-calculate">Calculate</button>
            </div>
            <a href="advanced-calculator.html" class="calc-btn advanced-calc-btn" data-i18n="btn-advanced">Advanced Calculator</a>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        var map = L.map('map', { zoomControl: false }).setView([41.88, -93.10], 7);

        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        });

        streetLayer.addTo(map);
        var currentBaseLayer = 'street';

        var MapToggleControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function () {
                var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                var btn = L.DomUtil.create('a', '', container);
                btn.href = '#';
                btn.title = 'Toggle map view';
                btn.style.cssText = 'width:auto;padding:0 8px;font-size:11px;line-height:26px;white-space:nowrap;';
                btn.textContent = 'Switch to Satellite';
                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.on(btn, 'click', function (e) {
                    L.DomEvent.preventDefault(e);
                    if (currentBaseLayer === 'street') {
                        map.removeLayer(streetLayer);
                        map.addLayer(satelliteLayer);
                        currentBaseLayer = 'satellite';
                        btn.textContent = 'Switch to Street Map';
                    } else {
                        map.removeLayer(satelliteLayer);
                        map.addLayer(streetLayer);
                        currentBaseLayer = 'street';
                        btn.textContent = 'Switch to Satellite';
                    }
                    updateIowaBorder();
                });
                return container;
            }
        });
        L.control.zoom({ position: 'topleft' }).addTo(map);
        new MapToggleControl().addTo(map);

        var layerGroups = {};
        var layerCache = {};
        var activeLoads = 0;
        var loadQueue = [];
        var MAX_CONCURRENT = 3;

        // Web worker handles fetch + JSON.parse off the main thread
        var worker = new Worker('geojson-worker.js');
        worker.onmessage = function(e) {
            var key = e.data.key;
            if (e.data.error) {
                console.warn('Layer load failed: ' + key, e.data.error);
            } else {
                layerCache[key] = e.data.data;
                renderLayer(key, e.data.data);
            }
            activeLoads--;
            processLoadQueue();
        };

        function processLoadQueue() {
            while (activeLoads < MAX_CONCURRENT && loadQueue.length > 0) {
                activeLoads++;
                var key = loadQueue.shift();
                worker.postMessage({ key: key, file: layerConfig[key].file });
            }
        }

        var allKeys = ['beef','dairy','swine','horses','turkeys','chickens','sheep',
                       'biodiesel','ethanol','wastewater',
                       'utilities','powerplants','pipelines','landfill','digesters','lmop'];

        var layerConfig = {
            beef:        { file: 'geojson/beef.geojson',        color: '#c87533', shape: 'circle' },
            dairy:       { file: 'geojson/dairy.geojson',       color: '#4a90d9', shape: 'circle' },
            swine:       { file: 'geojson/swine.geojson',       color: '#ff9eb5', shape: 'circle' },
            horses:      { file: 'geojson/horses.geojson',      color: '#a0a0a0', shape: 'circle' },
            turkeys:     { file: 'geojson/turkeys.geojson',     color: '#f4a460', shape: 'circle' },
            chickens:    { file: 'geojson/chickens.geojson',    color: '#ffd700', shape: 'circle' },
            sheep:       { file: 'geojson/sheep.geojson',       color: '#d2b48c', shape: 'circle' },
            biodiesel:   { file: 'geojson/biodiesel.geojson',   color: '#1abc9c', shape: 'droplet' },
            ethanol:     { file: 'geojson/ethanol.geojson',     color: '#e6c229', shape: 'droplet' },
            wastewater:  { file: 'geojson/wastewater.geojson',  color: '#3498db', shape: 'droplet' },
            utilities:   { file: 'geojson/utilities.geojson',   color: '#e67e22', shape: 'square' },
            powerplants: { file: 'geojson/powerplants.geojson', color: '#d94a4a', shape: 'square' },
            pipelines:   { file: 'geojson/pipelines.geojson',   line: '#4a5568' },
            landfill:    { file: 'geojson/landfill.geojson',    color: '#8b4513', shape: 'square' },
            digesters:   { file: 'geojson/digesters.geojson',   color: '#2ecc71', shape: 'circle' },
            lmop:        { file: 'geojson/lmop.geojson',        color: '#8e44ad', shape: 'circle' }
        };

        function buildLegend() {
            var div = document.createElement('div');
            div.className = 'legend';
            function li(id, svgHtml, label) {
                return '<label class="legend-item"><input type="checkbox" id="' + id + '" />' + svgHtml + '<span>' + label + '</span></label>';
            }
            function tri(c) { return '<svg width="16" height="12" viewBox="0 0 16 12"><polygon points="8,0 16,12 0,12" fill="' + c + '" stroke="#333" stroke-width="1"/></svg>'; }
            function circ(c) { return '<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="7" fill="' + c + '" stroke="#333" stroke-width="1"/></svg>'; }
            function rect(c) { return '<svg width="16" height="16" viewBox="0 0 16 16"><rect x="1" y="1" width="14" height="14" fill="' + c + '" stroke="#333" stroke-width="1"/></svg>'; }
            function dash(c) { return '<svg width="16" height="8" viewBox="0 0 16 8"><line x1="0" y1="4" x2="16" y2="4" stroke="' + c + '" stroke-width="3"/></svg>'; }
            function drop(c) { return '<svg width="12" height="16" viewBox="-1 -1 14 18"><path d="M6,0 C6,0 0,6 0,10 A6,6 0 0,0 12,10 C12,6 6,0 6,0Z" fill="' + c + '" stroke="#333" stroke-width="1"/></svg>'; }
            function blade(c) { return '<svg width="12" height="16" viewBox="0 0 12 16"><path d="M2,15 C0,10 2,4 7,0 C9,2 9,7 7,13 C6,16 3,16 2,15Z" fill="' + c + '" stroke="#333" stroke-width="1"/><path d="M4,14 C4,9 5,4 7,0" fill="none" stroke="rgba(0,0,0,0.25)" stroke-width="0.8"/></svg>'; }
            function paper(c) { return '<svg width="12" height="16" viewBox="-1 -1 14 18"><path d="M0,0 L9,0 L12,3 L12,16 L0,16 Z" fill="' + c + '" stroke="#333" stroke-width="1"/><path d="M9,0 L9,3 L12,3" fill="rgba(0,0,0,0.18)" stroke="#333" stroke-width="0.8"/></svg>'; }
            function grp(t, f) { return '<div class="legend-group' + (f ? ' first' : '') + '">' + t + '</div>'; }
            div.innerHTML =
                '<div class="legend-header"><h4>Legend</h4><div class="legend-btn-group"><button class="legend-clear-btn" id="legend-select-all-btn">Select All</button><button class="legend-clear-btn" id="legend-clear-all-btn" style="display:none">Clear All</button></div></div>' +
                grp('Agricultural Residue', true) +
                li('toggle-corn',        blade('#f5c518'),  'Corn Residue') +
                li('toggle-soybean',     blade('#7bc47f'),  'Soybean Residue') +
                grp('Feedlot Waste / Manure') +
                li('toggle-beef',        circ('#c87533'), 'Beef Cattle') +
                li('toggle-dairy',       circ('#4a90d9'), 'Dairy Cattle') +
                li('toggle-swine',       circ('#ff9eb5'), 'Swine') +
                li('toggle-horses',      circ('#a0a0a0'), 'Horses') +
                li('toggle-turkeys',     circ('#f4a460'), 'Turkeys') +
                li('toggle-chickens',    circ('#ffd700'), 'Chickens') +
                li('toggle-sheep',       circ('#d2b48c'), 'Sheep / Goats') +
                grp('Human Activity') +
                li('toggle-paperfood',   paper('#7f8c8d'), 'Paper / Food Mfg.') +
                li('toggle-biodiesel',   drop('#1abc9c'), 'Biodiesel Plants') +
                li('toggle-ethanol',     drop('#e6c229'), 'Ethanol Plants') +
                li('toggle-wastewater',  drop('#3498db'), 'Wastewater Treatment') +
                li('toggle-digesters',   circ('#2ecc71'), 'Anaerobic Digesters') +
                li('toggle-lmop',        circ('#8e44ad'), 'LMOP Sites') +
                grp('Utilities') +
                li('toggle-utilities',   dash('#e67e22'), 'Electric / Gas Utilities') +
                li('toggle-powerplants', rect('#d94a4a'), 'Power Plants') +
                li('toggle-pipelines',   dash('#4a5568'), 'Gas Pipelines') +
                li('toggle-landfill',    rect('#8b4513'), 'Landfill Sites');

            ['toggle-corn','toggle-soybean','toggle-paperfood'].forEach(function(id) {
                var item = div.querySelector('#' + id);
                if (item) item.parentElement.title = 'No items';
            });

            function updateLegendButtons() {
                var checkedCount = allKeys.filter(function (key) {
                    var cb = div.querySelector('#toggle-' + key);
                    return cb && cb.checked;
                }).length;
                var selectBtn = div.querySelector('#legend-select-all-btn');
                var clearBtn  = div.querySelector('#legend-clear-all-btn');
                if (checkedCount === 0) {
                    selectBtn.style.display = '';
                    clearBtn.style.display  = 'none';
                } else if (checkedCount === allKeys.length) {
                    selectBtn.style.display = 'none';
                    clearBtn.style.display  = '';
                } else {
                    selectBtn.style.display = '';
                    clearBtn.style.display  = '';
                }
            }

            div.querySelector('#legend-select-all-btn').addEventListener('click', function () {
                allKeys.forEach(function (key) {
                    var cb = div.querySelector('#toggle-' + key);
                    if (cb && !cb.checked) { cb.checked = true; toggleLayer(key, true); }
                });
                updateLegendButtons();
            });

            div.querySelector('#legend-clear-all-btn').addEventListener('click', function () {
                allKeys.forEach(function (key) {
                    var cb = div.querySelector('#toggle-' + key);
                    if (cb && cb.checked) { cb.checked = false; toggleLayer(key, false); }
                });
                updateLegendButtons();
            });

            allKeys.forEach(function (key) {
                var cb = div.querySelector('#toggle-' + key);
                if (cb) cb.addEventListener('change', function () {
                    toggleLayer(key, this.checked);
                    updateLegendButtons();
                });
            });
            L.DomEvent.disableScrollPropagation(div);
            L.DomEvent.disableClickPropagation(div);
            return div;
        }

        function makeMarkerIcon(cfg) {
            var s = 10;
            var html;
            if (cfg.shape === 'circle') {
                html = '<svg width="' + s + '" height="' + s + '" viewBox="0 0 ' + s + ' ' + s + '"><circle cx="' + (s/2) + '" cy="' + (s/2) + '" r="' + (s/2-1) + '" fill="' + cfg.color + '" stroke="#333" stroke-width="1"/></svg>';
            } else if (cfg.shape === 'droplet') {
                html = '<svg width="10" height="13" viewBox="0 0 10 13"><path d="M5,0 C5,0 0,6 0,9 A5,5 0 0,0 10,9 C10,6 5,0 5,0Z" fill="' + cfg.color + '" stroke="#333" stroke-width="1"/></svg>';
                return L.divIcon({ html: html, className: '', iconSize: [10, 13], iconAnchor: [5, 13] });
            } else {
                html = '<svg width="' + s + '" height="' + s + '" viewBox="0 0 ' + s + ' ' + s + '"><rect x="1" y="1" width="' + (s-2) + '" height="' + (s-2) + '" fill="' + cfg.color + '" stroke="#333" stroke-width="1"/></svg>';
            }
            return L.divIcon({ html: html, className: '', iconSize: [s, s], iconAnchor: [s/2, s/2] });
        }

        function createClusterGroup(cfg) {
            return L.markerClusterGroup({
                // Cluster radius decreases smoothly as zoom increases — gradient ungrouping
                maxClusterRadius: function (zoom) {
                    return Math.max(5, 110 - zoom * 8);
                },
                disableClusteringAtZoom: 15,
                iconCreateFunction: function (cluster) {
                    var count = cluster.getChildCount();
                    // Size scales logarithmically with count
                    var size = Math.round(Math.min(54, 22 + Math.log(count + 1) * 6));
                    var half = size / 2;
                    if (cfg.shape === 'droplet') {
                        var h = Math.round(size * 1.3);
                        var cy = h - Math.round(half);
                        var path = 'M' + half + ',0 C' + half + ',0 0,' + Math.round(cy * 0.65) + ' 0,' + cy + ' A' + half + ',' + half + ' 0 0,0 ' + size + ',' + cy + ' C' + size + ',' + Math.round(cy * 0.65) + ' ' + half + ',0 ' + half + ',0Z';
                        var dHtml = '<svg width="' + size + '" height="' + h + '" viewBox="0 0 ' + size + ' ' + h + '"><path d="' + path + '" fill="' + cfg.color + '" stroke="#333" stroke-width="1.5"/></svg>';
                        return L.divIcon({ html: dHtml, className: '', iconSize: [size, h], iconAnchor: [Math.round(half), h] });
                    }
                    var shapeEl;
                    if (cfg.shape === 'circle') {
                        shapeEl = '<circle cx="' + half + '" cy="' + half + '" r="' + (half - 1.5) + '" fill="' + cfg.color + '" stroke="#333" stroke-width="1.5"/>';
                    } else {
                        shapeEl = '<rect x="1.5" y="1.5" width="' + (size - 3) + '" height="' + (size - 3) + '" fill="' + cfg.color + '" stroke="#333" stroke-width="1.5"/>';
                    }
                    var html = '<svg width="' + size + '" height="' + size + '" viewBox="0 0 ' + size + ' ' + size + '">' +
                               shapeEl +
                               '</svg>';
                    return L.divIcon({
                        html: html,
                        className: '',
                        iconSize: [size, size],
                        iconAnchor: [Math.round(half), Math.round(half)]
                    });
                },
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                chunkedLoading: true,
                chunkSize: 200,
                chunkDelay: 100
            });
        }

        function renderLayer(key, geojson) {
            var cfg = layerConfig[key];
            if (!layerGroups[key]) {
                layerGroups[key] = cfg.line ? L.layerGroup() : createClusterGroup(cfg);
                layerGroups[key].addTo(map);
            } else {
                layerGroups[key].clearLayers();
            }
            if (cfg.line) {
                geojson.features.forEach(function (feature) {
                    var coords = feature.geometry.coordinates.map(function (c) { return [c[1], c[0]]; });
                    L.polyline(coords, { color: cfg.line, weight: 2.5, opacity: 0.9 }).addTo(layerGroups[key]);
                });
            } else {
                var icon = makeMarkerIcon(cfg);
                var markers = [];
                geojson.features.forEach(function (feature) {
                    var c = feature.geometry.coordinates;
                    var marker = L.marker([c[1], c[0]], { icon: icon });
                    var p = feature.properties;
                    var name = p.facName || p.Plant || p.Name || p.PLANT_NAME || p.COMPANY_NA || p.LandfillNa || '';
                    var city = p.CityName || p.City || p.CITY || '';
                    if (name || city) {
                        marker.bindPopup('<strong>' + name + '</strong>' + (city ? '<br>' + city + ', IA' : ''));
                    }
                    markers.push(marker);
                });
                layerGroups[key].addLayers(markers);
            }
        }

        function loadLayer(key) {
            var cfg = layerConfig[key];
            if (!cfg) return;
            if (layerCache[key]) { renderLayer(key, layerCache[key]); return; }
            // Queue the fetch; max 3 concurrent loads to avoid browser overload
            if (loadQueue.indexOf(key) === -1) {
                loadQueue.push(key);
                processLoadQueue();
            }
        }

        function toggleLayer(key, visible) {
            if (visible) {
                if (!layerCache[key] && layerConfig[key]) { loadLayer(key); return; }
                if (layerGroups[key]) map.addLayer(layerGroups[key]);
            } else {
                if (layerGroups[key]) map.removeLayer(layerGroups[key]);
            }
        }

        // Iowa state border — color adapts to active base layer
        var iowaLayer = null;
        function updateIowaBorder() {
            if (!iowaLayer) return;
            if (currentBaseLayer === 'satellite') {
                iowaLayer.setStyle({ color: '#ffffff', weight: 1.5, opacity: 0.4 });
            } else {
                iowaLayer.setStyle({ color: '#888', weight: 1.5, opacity: 0.4 });
            }
        }
        fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                var iowa = data.features.find(function (f) { return f.properties.name === 'Iowa'; });
                if (iowa) {
                    iowaLayer = L.geoJSON(iowa, { style: { fillOpacity: 0, color: '#888', weight: 1.5, opacity: 0.4 } }).addTo(map);
                }
            });

        // Legend as a Leaflet control
        var LegendControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function () { return buildLegend(); }
        });
        new LegendControl().addTo(map);

        // Sidebar state
        if (localStorage.getItem('sidebar') === 'hidden') {
            document.querySelector('.page-layout').classList.add('sidebar-hidden');
            var t = document.getElementById('sidebar-toggle-btn');
            if (t) t.innerHTML = '&#8594;';
        }
        function toggleCalcPanel() {
            var panel = document.getElementById('calculator-panel');
            var btn = document.getElementById('calc-panel-toggle');
            var collapsed = panel.classList.toggle('collapsed');
            btn.innerHTML = collapsed ? '&#9664;' : '&#9654;';
            btn.title = collapsed ? 'Show calculator' : 'Hide calculator';
            setTimeout(function () { map.invalidateSize(); }, 260);
        }

        function toggleSidebar() {
            var layout = document.querySelector('.page-layout');
            layout.classList.toggle('sidebar-hidden');
            var hidden = layout.classList.contains('sidebar-hidden');
            localStorage.setItem('sidebar', hidden ? 'hidden' : 'visible');
            var t = document.getElementById('sidebar-toggle-btn');
            if (t) t.innerHTML = hidden ? '&#8594;' : '&#8592;';
            setTimeout(function () { map.invalidateSize(); }, 10);
        }
    </script>
</body>
</html>
